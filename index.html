<!DOCTYPE html>
<html>
<head>
	<title>Vid Scraper</title>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<link rel="stylesheet" type="text/css" href="./stylesheet.css">
</head>
<body>

<h1>Video Web Scraper</h1>

<p class="error">Type in a keyword</p>
<div class="search-form">
	<input type="text" id="keyword" placeholder="keyword">
	<button>Search</button>
</div>

<div class="videos-list"></div>

<script>
var error = document.querySelector(".error");
var input = document.querySelector("input");
var button = document.querySelector("button");
var videosList = document.querySelector(".videos-list");
let buttonInterval;
let statusInterval;
let resultLinks = [[]];

document.querySelector("button").addEventListener("click", () => {
	
	if (checkErrors()) return;
	setButtonLoading();

	axios.post("/", {
		keyword: input.value
	})
	.then(function(){
		statusInterval = setInterval(() => {
			axios.get("/status")
			.then(res => {
				grabData(res);
				setButtons();
				if (res.data.finished) {
					resetButton();
					clearInterval(statusInterval);
				}
				setTimeout(() => {
					removeBrokenVideos();
				}, 4000)
			})
			.catch(() => {
				resetButton();
			})
		}, 5000)
	})
})

function grabData(res) {
	res.data.links.forEach((vids, a) => {
		vids.forEach(vid => {
			let videoTag = document.createElement("video");
			videosList.appendChild(videoTag);
			videoTag.outerHTML = `<video width="720" height="404" data-id='${a + vid}' controls>
			<source src="${vid}"></video>`;

			let button = document.createElement("button");
			videosList.appendChild(button);
			button.outerHTML = `<button class="remove-vid-btn" data-vid-id='${a + vid}'>Remove</button>`;
		})
	});
}

function setButtons() {
	let buttons = document.querySelectorAll("button");
	for (let button of buttons) {
		button.addEventListener("click", (e) => {
			let vid = document.querySelector(`[data-id='${e.currentTarget.getAttribute('data-vid-id')}']`);
			videosList.removeChild(vid);
			e.currentTarget.outerHTML = "";
		})
	}
}

function removeVideo(video) {
	videosList.removeChild(video);
}

function removeBrokenVideos() {
	let videos = document.querySelectorAll("video");

	for(let video of videos){
		let dur = video.duration;
		let state = video.readyState;
		if (state === 0 || (state === 4 && !(dur > 1))) {
			videosList.removeChild(video);
		}
	}
}

function checkErrors() {
	if (input.value == "") {
		error.style.visibility = "visible";
		return true;
	}
	else {
		error.style.visibility = "hidden";
		return false;
	}
}

function setButtonLoading() {
	button.disabled = true;
	let searching = ["Searching.", "Searching..", "Searching..."];
	let i = 0;
	buttonInterval = setInterval((searching, i) => {
		button.textContent = searching[i];
		i === 2 ? i = 0 : i++;
	}, 200)
}

function resetButton() {
	clearInterval(buttonInterval);
	button.textContent = "Search";
	button.disabled = false;
}
</script>

</body>
</html>